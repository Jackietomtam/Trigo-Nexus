# 图表直线问题诊断报告

## 📋 问题现象

用户反馈：Edition 2页面的图表前面正常波动，后来变成一条水平直线。

## 🔍 诊断过程

### 1. 检查服务器日志

发现**严重问题**：
- ❌ systemd服务疯狂重启（已重启13,288次！）
- ❌ 端口5001被占用，导致服务无法启动
- ❌ systemd配置运行的是`app_v2.py`（旧版本），而实际应该运行`app_dual_edition.py`

### 2. 检查进程状态

发现有**Gunicorn进程**在正常运行：
```
PID 66244/66245: gunicorn运行app_dual_edition:app
启动时间: Oct 27（已运行1天+）
端口: 5001
状态: 正常运行
```

### 3. 检查API数据

**初次查询**（异常）：
- 持仓数量：`quantity: 3.254178844583045e-08`（接近0）
- 未实现盈亏：`unrealized_pnl: 1.52946405695412e-08`（接近0）

**二次查询**（正常）：
- DEEPSEEK V3.2: `unrealized_pnl=$114.93`
- QWEN3 MAX: `unrealized_pnl=$5,225.05`

**结论**：数据在实时变化，第一次查询可能正好是平仓后的瞬间。

### 4. 检查历史数据

```
DEEPSEEK V3.2:
  数据点总数: 9,985个
  最近10个值有波动
  差值: $196.68

QWEN3 MAX:
  数据点总数: 9,985个
  最近10个值有波动
  差值: $77.27
```

**结论**：✅ 后端历史数据正常，有波动！

## 🎯 问题根因

**真正的问题不是数据，而是前端！**

1. **WebSocket事件不匹配**：
   - 前端监听：`market_update`
   - 后端发送：`edition2_update`
   - 结果：前端收不到实时更新

2. **历史数据不刷新**：
   - 前端只在页面加载时获取一次历史数据
   - 之后不再更新
   - 导致图表"冻结"在初始状态

3. **浏览器缓存**：
   - 用户看到的可能是缓存的旧JavaScript文件
   - 即使修复代码，浏览器仍用旧版本

## ✅ 修复方案

### 修复1：修正WebSocket事件监听

**文件**：`static/js/app.js`

```javascript
initSocket() {
    this.socket = io();
    this.socket.on('connect', () => console.log('✓ 已连接'));
    
    // 根据当前页面监听对应的事件
    const currentPath = window.location.pathname;
    if (currentPath.includes('/edition1')) {
        this.socket.on('edition1_update', (d) => this.onUpdate(d));
    } else if (currentPath.includes('/edition2')) {
        this.socket.on('edition2_update', (d) => this.onUpdate(d));  // ✅ 修正
    }
}
```

### 修复2：添加定期刷新历史数据

**文件**：`static/js/app.js`

```javascript
init() {
    this.initSocket();
    this.initChart();
    this.setupEvents();
    this.loadAll();
    
    // ✅ 每30秒更新一次历史数据
    setInterval(() => {
        this.api('/api/history').then(hist => {
            if (hist) this.updateChart(hist);
        }).catch(e => console.error('更新历史数据失败:', e));
    }, 30000);
}
```

### 修复3：停止systemd冲突服务

已执行：
```bash
sudo systemctl stop trigo-nexus
sudo systemctl disable trigo-nexus
```

这避免了无休止的重启，让正在运行的Gunicorn服务继续工作。

## 📝 部署步骤

1. **提交代码修改**：
```bash
cd /Users/sogmac/Desktop/Agent-Test/AI交易
git add static/js/app.js 图表直线问题修复.md 图表问题诊断报告.md
git commit -m "修复图表直线问题：添加历史数据定期刷新和WebSocket事件修正"
git push
```

2. **SSH到服务器并更新代码**：
```bash
ssh -i ~/Downloads/trigo-key.pem ubuntu@3.106.191.40
cd /opt/ai-trader
git pull
```

3. **重启Gunicorn服务**：
```bash
# 找到Gunicorn进程
ps aux | grep gunicorn | grep -v grep

# 优雅重启（发送HUP信号）
kill -HUP 66244

# 或强制重启
kill 66244 66245
cd /opt/ai-trader
source venv/bin/activate
nohup gunicorn -k eventlet -w 1 --bind 0.0.0.0:5001 --timeout 120 app_dual_edition:app &
```

4. **清除浏览器缓存**：
   - Chrome/Safari: `Cmd + Shift + R`（强制刷新）
   - 或手动清除网站数据

## 🎉 预期效果

修复后：
1. ✅ 图表每30秒自动刷新
2. ✅ 显示真实的账户价值波动
3. ✅ WebSocket实时更新价格和排行榜
4. ✅ 不再出现"直线"问题

## 📊 验证方法

1. 访问 https://trigonexus.us/edition2
2. 打开浏览器控制台（F12）
3. 查看是否有日志：`监听 edition2_update 事件`
4. 等待30秒，观察图表是否更新
5. 检查网络请求是否定期调用 `/api/edition2/history`

## 📅 修复时间

2025-10-28 17:30 (中国时间)

## 👨‍💻 工程师

AI Assistant (Claude Sonnet 4.5)

